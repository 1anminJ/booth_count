<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>신분 선택</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
</head>
<body>
<header class="top-header">
    <div class="header-content">DMU</div>
  </header>
  <div class="page-wrapper">
    <div class="content-wrapper">
      <img src="{{ url_for('static', filename='img/nodle.png') }}" alt="노들 이미지" class="top-image">
      <div class="container">
      <h2>당신의 신분을 선택해주세요</h2>
      <form id="identityForm" method="POST" action="/feedback">
        <input type="hidden" name="uuid" id="uuid">
        <input type="hidden" name="area" id="area">
        <input type="hidden" name="identity" id="identity">
        <button type="button" onclick="checkLocationAndSubmit('STUDENT')">재학생</button>
        <button type="button" onclick="checkLocationAndSubmit('GRADUATE')">졸업생</button>
        <button type="button" onclick="checkLocationAndSubmit('STAFF')">교직원</button>
        <button type="button" onclick="checkLocationAndSubmit('GENERAL')">일반인</button>
      </form>
        </div>
    </div>
  </div>

  <script>
    function setIdentity(identity) {
      document.getElementById("identity").value = identity;
    }

    function toRad(value) {
      return value * Math.PI / 180;
    }

    function calculateDistance(lat1, lon1, lat2, lon2) {
      const R = 6378137;
      const dLat = toRad(lat2 - lat1);
      const dLon = toRad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function getOrCreateUUID() {
      const cookieName = "visitor_uuid=";
      const cookies = document.cookie.split(';');
      let found = false;
      for (let i = 0; i < cookies.length; i++) {
        const c = cookies[i].trim();
        if (c.indexOf(cookieName) === 0) {
          document.getElementById("uuid").value = c.substring(cookieName.length);
          found = true;
          break;
        }
      }
      if (!found) {
        const uuid = crypto.randomUUID();
        document.cookie = cookieName + uuid + "; path=/; max-age=2592000";
        document.getElementById("uuid").value = uuid;
      }

      const urlParams = new URLSearchParams(window.location.search);
      const area = urlParams.get('area');
      if (area) {
        document.getElementById("area").value = area;
      }
    }

    function checkLocationAndSubmit(identity) {
    setIdentity(identity);
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(function(position) {
        const userLat = position.coords.latitude;
        const userLon = position.coords.longitude;
        const baseLat = 37.50092688176289;
        const baseLon = 126.86744039265021;
        const distance = calculateDistance(baseLat, baseLon, userLat, userLon);
        // TODO: 테스트 위해 100km로 설정
        if (distance > 100000) {
          console.error("distance:", distance);
          alert("유효하지 않은 위치입니다. 부스에 가까운 곳에서 참여해주세요.");
          return;
        }
        document.getElementById("identityForm").submit();
      }, function(error) {
        console.error("Error getting distance data.", error);
        alert("위치 정보를 가져오는 데 실패했습니다.");
      });
    } else {
      alert("지원되지 않는 브라우저입니다.");
    }
  }

    window.onload = function() {
      getOrCreateUUID();
    };
  </script>
<footer class="footer">
  <p>Developed by
    <a href="https://github.com/1anminJ" target="_blank">@1anminJ</a> &amp;
    <a href="https://github.com/ysw789" target="_blank">@ysw789</a> &amp;
    <a href="https://github.com/JungwooJoon" target="_blank">@JungwooJoon</a>
  </p>
</footer>

</body>
</html>
